# Описание БЛОГА
Содержит простую БД с сущностями:

-User(id, login) - Содержит пользователей, являющихся авторами постов.

-Post(id, header, content, author_ip, user_id) - Содержит посты и информацию о них.

-Rating(id, value, post_id) - Содержит оценки постов.
 
 Служебные таблицы для обеспечения быстрых вычислений и получения данных по запросам:
 
 -statistics(id, post_id, rating_sum, rating_count, rating_avg) - Содержит суммарную информацию об оценках постов
 
 -ip_addresses(id, ip_address, users) - содержит ip-адреса и списки пользователей, которые были замечены размещающими посты с этих адресов.

Проект представляет собой JSON API приложение предоставляющее следующие методы:

1) /post/create_post . Создает новый пост. Принимает параметры:
    
      - header - заголовок поста.
      - content - содержание поста.
      - user_name - login автора.
      - author_ip - ip-адрес автора в формате 'x.x.x.x'
      
      Возвращает - параметры созданного поста.

1) /post/rate_post . Добавляет оценку для поста. Принимает параметры:
    
      - value - оценка поста. допустимы значения от 1.00 до 5.00.
      - post_id - идентификатор поста.
      
      Возвращает - новый средний рейтинг оцененного поста.

1) /post/posts_by_rating . Выбирает посты по переданному среднему рейтингу. Принимает параметры:
    
      - rating - средний рейтинг.
      - posts_count - максимальное количество выдаваемых постов с данным рейтингом.
      
      Возвращает - массив постов с заголовками и содержанием.

1) /post/ip_and_authors . Выдает ip-адреса, с которых были замечены как минимум users_count авторов, размещающих посты. Принимает параметры:
    
      - users_count - минимально замеченное количество авторов.
      
      Возвращает массив ip-адресов и список замеченных на них пользователях. Списки пользователей возвращаются в том виде, в каком они хранятся в БД POstgres в поле с табличным типом bigint[]
      
      С помощью задачи 
      ```ruby
      rails db:seed
      ```
      можно в БД залить тестовые данные. Перед запуском можно настроить количество заливаемых тестовых данных в файле db/seeds.rb.
      
      Для настройки доступны следующие параметры:
      
      - users_count = 100 - количество авторов.
      - ip_addresses_count = 50 - количество разных ip-адресов.
      - posts_count = 200000 - количество постов.
      - ratings_count = 200000 - количество оценок.
      - use_controllers_code = false - использовать ли методы контроллера для заливки тестовых данных. При использовании методов контроллера скорость заливки данных не превышает 500 записей в секунду, с использованием прямых sql-запросов скорость заливки ~ от 6000 до 13000 записей в секунду (для значений по умолчанию).
      
      Для ускорения работы почти везде используются прямые SQL-запросы, на сторне БД производятся валидации, а также срабатывают триггеры, пересчитывающие средний рейтинг и учитывающие учет ip-адресов, использованных пользователями.
      
      Для хранения расчётных данных по рейтингу была выбрана отдельная таблица, хотя возможны и другие варианты - например, в дополнительном столбце в таблице posts. Потокобезопасность запроса при пересчёте среднего рейтинга обеспечивается выполнением добавления оценки и пересчёта среднего рейтинга внутри одной транзакции.
      
      Скорость работы всех методов при количестве записей по умолчанию (~400 000) - более 99% запросов попадают в диапазон 8 - 42 мс.
      
      При тестировании БД с 1000 пользователей, 5000 ip-адресов, 2 000 000 постов, 2 000 000 оценок время работы 1 и 2 метода заметно не увеличилось, время работы 3 метода так же заметно не изменилось, кроме случаев поиска постов с несуществующим средним рейтингом - в этом случае время работы метода составляет ~ 300-400мс. Метод 4 при наличии в выборке ~350 записей составляет 90±10мс, и возрастает примерно до 900мс при выдаче всех 5000 ip-адресов со списками всех замеченных на них авторов(в сумме ~151000 users).
      
      Тестирование проводилось на домашнем ноутбуке в приложении Postman.
      
      В случае, если значительно, на порядки, будет возрастать количество авторов и ip-адресов, есть смысл изменить инфраструктуру хранения соответствующих данных, например, отказаться от использования столбца типа bigint[], либо ввести параметр для ограничения количества выдаваемых результатов в одном запросе. Если же кратно возрастать будет количество постов и оценок, то текущая инфрастрактура имеет достаточный запас прочности для как минимум десятикратного распухания.
      
      Проект создан командой
      ```ruby
      rails new
      ```
      кроме этого генераторы не использовались.
